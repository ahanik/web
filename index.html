<!DOCTYPE html>
<html lang="en">

<head>

    <link rel="manifest" href="manifest.json" />
<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered! Scope is:', registration.scope);
                })
                .catch(err => {
                    console.error('Service Worker registration failed:', err);
                });
        });
    }
</script>


    
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SnacksLab POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Include jspdf-autotable for easy table generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.14/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getDatabase, ref as dbRef, onValue, update, remove, push, set, get } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

        // Firebase Configuration - REPLACE WITH YOUR OWN if different!
        const firebaseConfig = {
            apiKey: "AIzaSyBXMAi6aFQA6qv8N-pjJGS23XVk6xuNWsg",
            authDomain: "restaurant-demo-5497d.firebaseapp.com",
            databaseURL: "https://restaurant-demo-5497d-default-rtdb.firebaseio.com",
            projectId: "restaurant-demo-5497d",
            storageBucket: "restaurant-demo-5497d.appspot.com",
            messagingSenderId: "172194803127",
            appId: "1:172194803127:web:bf1e6d7824a94e1b328c32",
            measurementId: "G-DKXJD670KL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentOrder = []; // Array to hold items in the current order for POS
        let discountType = null; // 'percentage' or 'cash'
        let discountValue = 0;
        let taxPercentage = 0;
        let currentReportData = []; // To store fetched sales data for PDF export

        // Restaurant Logo SVG (inline)
        const restaurantLogoSVG = `
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z" fill="#22C55E"/>
                <path d="M12 6C9.79086 6 8 7.79086 8 10C8 12.2091 9.79086 14 12 14C14.2091 14 16 12.2091 16 10C16 7.79086 14.2091 6 12 6Z" fill="#FDE047"/>
                <path d="M12 14V18" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 17H14" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M17 10H7" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        `;

        document.addEventListener("DOMContentLoaded", () => {
            // --- DOM Elements for Homepage Navigation ---
            const homePage = document.getElementById("homePage");
            const manageItemsView = document.getElementById("manageItemsView");
            const posView = document.getElementById("posView");
            const salesReportView = document.getElementById("salesReportView");

            const manageItemsBtn = document.getElementById("manageItemsBtn");
            const sellItemsBtn = document.getElementById("sellItemsBtn");
            const generateReportBtn = document.getElementById("generateReportBtn");

            // --- DOM Elements for Item Management ---
            const addItemForm = document.getElementById("addItemForm");
            const manageItemsList = document.getElementById("manageItemsList");

            // --- DOM Elements for POS ---
            const posItemsList = document.getElementById("posItemsList");
            const orderList = document.getElementById("orderList");
            const totalQtySpan = document.getElementById("totalQty");
            const subtotalSpan = document.getElementById("subtotal");
            const finalTotalSpan = document.getElementById("finalTotal");
            const cashDiscountBtn = document.getElementById("cashDiscountBtn");
            const percentageDiscountBtn = document.getElementById("percentageDiscountBtn");
            const discountInputGroup = document.getElementById("discountInputGroup");
            const discountInput = document.getElementById("discountInput");
            const taxInput = document.getElementById("taxInput");
            const customerPhoneInput = document.getElementById("customerPhone");
            const couponCodeInput = document.getElementById("couponCode");
            const printReceiptBtn = document.getElementById("printReceiptBtn");
            const clearOrderBtn = document.getElementById("clearOrderBtn");
            const orderStatusList = document.getElementById("orderStatusList"); // New: Order Status List

            // --- DOM Elements for Sales Report ---
            const totalSalesReport = document.getElementById("totalSalesReport");
            const ordersReportList = document.getElementById("ordersReportList");
            const todaySalesBtn = document.getElementById("todaySalesBtn");
            const fromDateInput = document.getElementById("fromDate");
            const toDateInput = document.getElementById("toDate");
            const generateDateRangeReportBtn = document.getElementById("generateDateRangeReportBtn");
            const exportSalesReportPdfBtn = document.getElementById("exportSalesReportPdfBtn");
            const searchReportInput = document.getElementById("searchReportInput"); // New: Search input
            const searchReportType = document.getElementById("searchReportType"); // New: Search type dropdown
            const searchReportBtn = document.getElementById("searchReportBtn"); // New: Search button


            // --- Real-time Date and Time Display ---
            const dateTimeDisplay = document.getElementById("dateTimeDisplay");

            // --- Insert Logo into Headers (now only for the main header bar) ---
            document.getElementById('mainHeaderTitle').insertAdjacentHTML('afterbegin', restaurantLogoSVG);
            // Removed individual header insertions as they are now part of the main header


            function updateDateTime() {
                const now = new Date();
                const optionsDate = { year: 'numeric', month: 'long', day: 'numeric' };
                const optionsTime = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true, timeZone: 'Asia/Dhaka' }; // Bangladesh Time
                const dateString = now.toLocaleDateString('en-US', optionsDate);
                const timeString = now.toLocaleTimeString('en-US', optionsTime);
                dateTimeDisplay.textContent = `${dateString} | ${timeString} BD`;
            }

            // Update time every second
            setInterval(updateDateTime, 1000);
            updateDateTime(); // Initial call

            // --- View Management Function ---
            function showView(viewId) {
                homePage.classList.add('hidden');
                manageItemsView.classList.add('hidden');
                posView.classList.add('hidden');
                salesReportView.classList.add('hidden');

                document.getElementById(viewId).classList.remove('hidden');

                // Update active state of header buttons
                document.querySelectorAll('.header-nav-btn').forEach(btn => {
                    btn.classList.remove('bg-black', 'text-white'); // Remove hover active styles
                    btn.classList.add('text-gray-800'); // Set default text color
                });
                if (viewId === 'manageItemsView') {
                    document.getElementById('navManageItemsBtn').classList.remove('text-gray-800');
                    document.getElementById('navManageItemsBtn').classList.add('bg-gray-200'); // Active state for off-white theme
                    loadManageItems(); // Load items for management
                } else if (viewId === 'posView') {
                    document.getElementById('navSellItemsBtn').classList.remove('text-gray-800');
                    document.getElementById('navSellItemsBtn').classList.add('bg-gray-200'); // Active state for off-white theme
                    loadPosItems(); // Load items for selection in POS
                    updatePaymentSection(); // Ensure POS section is updated
                    loadProcessingOrders(); // New: Load orders for status tracking
                } else if (viewId === 'salesReportView') {
                    document.getElementById('navSalesReportBtn').classList.remove('text-gray-800');
                    document.getElementById('navSalesReportBtn').classList.add('bg-gray-200'); // Active state for off-white theme
                    // Set default dates to today for convenience
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    const todayIso = `${year}-${month}-${day}`;

                    fromDateInput.value = todayIso;
                    toDateInput.value = todayIso;
                    loadSalesReport(todayIso, todayIso); // Load today's sales by default
                } else if (viewId === 'homePage') {
                    // No active button for home, or you could add a home button to the header too
                }
            }

            // --- Homepage Navigation Event Listeners ---
            manageItemsBtn.addEventListener("click", () => showView("manageItemsView"));
            sellItemsBtn.addEventListener("click", () => showView("posView"));
            generateReportBtn.addEventListener("click", () => showView("salesReportView"));

            // --- Header Navigation Event Listeners ---
            document.getElementById('navManageItemsBtn').addEventListener("click", () => showView("manageItemsView"));
            document.getElementById('navSellItemsBtn').addEventListener("click", () => showView("posView"));
            document.getElementById('navSalesReportBtn').addEventListener("click", () => showView("salesReportView"));
            document.getElementById('mainHeaderTitle').addEventListener("click", () => showView("homePage")); // Click title to go home
            document.getElementById('loginBtn').addEventListener("click", () => alert("Login functionality would go here!")); // Placeholder for login


            // --- Item Management Functions ---
            function loadManageItems() {
                onValue(dbRef(db, 'items'), (snapshot) => {
                    manageItemsList.innerHTML = '';
                    if (!snapshot.exists()) {
                        manageItemsList.innerHTML = '<p class="col-span-full text-center text-gray-500">No items added yet. Use the form above to add products.</p>';
                        return;
                    }
                    snapshot.forEach(child => {
                        const item = child.val();
                        const key = child.key;
                        const card = document.createElement('div');
                        card.className = "bg-white p-4 rounded-lg shadow-md w-full flex flex-col items-center text-center"; // No cursor-pointer for management view
                        card.innerHTML = `
                            <img src="${item.imageUrl}" class="w-24 h-24 object-cover rounded-full mb-2" alt="${item.name}" />
                            <h3 class="font-bold mt-2 text-lg text-gray-800">${item.name}</h3>
                            <p class="text-sm text-gray-600">Cost: TK${item.costPrice}</p>
                            <p class="text-sm mb-2 text-gray-700 font-semibold">Sell: TK${item.sellingPrice}</p>
                            <div class="flex gap-2">
                                <button class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm" onclick="editItem('${key}')">Edit</button>
                                <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm" onclick="deleteItem('${key}')">Delete</button>
                            </div>
                        `;
                        manageItemsList.appendChild(card);
                    });
                });
            }

            window.editItem = function (key) {
                const itemRef = dbRef(db, 'items/' + key);
                get(itemRef).then((snapshot) => { // Use get for one-time read
                    if (snapshot.exists()) {
                        const item = snapshot.val();
                        document.getElementById("itemName").value = item.name;
                        document.getElementById("itemImageUrl").value = item.imageUrl;
                        document.getElementById("itemCost").value = item.costPrice;
                        document.getElementById("itemSell").value = item.sellingPrice;
                        addItemForm.setAttribute("data-key", key);
                    } else {
                        alert("Item not found for editing.");
                    }
                }).catch(error => console.error("Error fetching item for edit:", error));
            }

            window.deleteItem = function (key) {
                if (confirm("Are you sure you want to delete this item?")) { // Using confirm for simplicity, but custom modal is better
                    remove(dbRef(db, 'items/' + key))
                        .then(() => alert("Item deleted successfully!"))
                        .catch(error => console.error("Error deleting item:", error));
                }
            }

            addItemForm.addEventListener("submit", (e) => {
                e.preventDefault();
                const name = document.getElementById("itemName").value.trim();
                const imageUrl = document.getElementById("itemImageUrl").value.trim();
                const costPrice = parseFloat(document.getElementById("itemCost").value);
                const sellingPrice = parseFloat(document.getElementById("itemSell").value);

                if (!name || !imageUrl || isNaN(costPrice) || isNaN(sellingPrice)) {
                    alert("Please fill all item fields correctly.");
                    return;
                }

                const itemData = { name, imageUrl, costPrice, sellingPrice };

                const key = addItemForm.getAttribute("data-key");
                if (key) {
                    update(dbRef(db, 'items/' + key), itemData)
                        .then(() => alert("Item updated successfully!"))
                        .catch(error => console.error("Error updating item:", error));
                    addItemForm.removeAttribute("data-key");
                } else {
                    set(dbRef(db, 'items/' + name), itemData) // Using name as key for items for simplicity
                        .then(() => alert("Item added successfully!"))
                        .catch(error => console.error("Error adding item:", error));
                }

                addItemForm.reset();
                loadManageItems(); // Reload items after add/update
            });

            // --- POS Item Loading ---
            function loadPosItems() {
                onValue(dbRef(db, 'items'), (snapshot) => {
                    posItemsList.innerHTML = '';
                    if (!snapshot.exists()) {
                        posItemsList.innerHTML = '<p class="col-span-full text-center text-gray-500">No products available. Please add items in the "Add/Edit Products" section.</p>';
                        return;
                    }
                    snapshot.forEach(child => {
                        const item = child.val();
                        const card = document.createElement('div');
                        card.className = "bg-white p-4 rounded-lg shadow-md w-full flex flex-col items-center text-center cursor-pointer hover:bg-gray-100 transition-colors duration-200";
                        card.innerHTML = `
                            <img src="${item.imageUrl}" class="w-24 h-24 object-cover rounded-full mb-2" alt="${item.name}" />
                            <h3 class="font-bold mt-2 text-lg text-gray-800">${item.name}</h3>
                            <p class="text-sm mb-2 text-gray-700 font-semibold">Sell: TK${item.sellingPrice}</p>
                        `;
                        card.onclick = () => addToOrder(item); // Add to order on click
                        posItemsList.appendChild(card);
                    });
                });
            }

            // --- Order Management Functions (for POS view) ---
            function addToOrder(item) {
                const existingItemIndex = currentOrder.findIndex(orderItem => orderItem.name === item.name);

                if (existingItemIndex > -1) {
                    currentOrder[existingItemIndex].quantity++;
                } else {
                    currentOrder.push({ ...item, quantity: 1 });
                }
                updatePaymentSection();
            }

            window.updateOrderQuantity = function (index, delta) {
                currentOrder[index].quantity += delta;
                if (currentOrder[index].quantity <= 0) {
                    currentOrder.splice(index, 1); // Remove if quantity is 0 or less
                }
                updatePaymentSection();
            }

            window.removeItemFromOrder = function (index) {
                currentOrder.splice(index, 1);
                updatePaymentSection();
            }

            function calculateTotals() {
                let subtotal = currentOrder.reduce((sum, item) => sum + (item.sellingPrice * item.quantity), 0);
                let totalQuantity = currentOrder.reduce((sum, item) => sum + item.quantity, 0);
                let discountAmount = 0;

                if (discountType === 'percentage' && discountValue > 0) {
                    discountAmount = subtotal * (discountValue / 100);
                } else if (discountType === 'cash' && discountValue > 0) {
                    discountAmount = discountValue;
                }

                const totalAfterDiscount = subtotal - discountAmount;
                const taxAmount = totalAfterDiscount * (taxPercentage / 100);
                const finalTotal = totalAfterDiscount + taxAmount;

                return { subtotal, totalQuantity, discountAmount, taxAmount, finalTotal };
            }

            function updatePaymentSection() {
                orderList.innerHTML = '';
                if (currentOrder.length === 0) {
                    orderList.innerHTML = '<p class="text-gray-500 text-center">No items in order.</p>';
                } else {
                    currentOrder.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.className = "flex justify-between items-center py-2 border-b last:border-b-0";
                        li.innerHTML = `
                            <div class="flex-1">
                                <span class="font-medium text-gray-800">${item.name}</span>
                                <span class="text-sm text-gray-600 block">TK${item.sellingPrice.toFixed(2)} x ${item.quantity}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="font-semibold text-gray-800">TK${(item.sellingPrice * item.quantity).toFixed(2)}</span>
                                <button onclick="updateOrderQuantity(${index}, 1)" class="bg-green-200 text-green-800 px-2 py-1 rounded-full text-xs hover:bg-green-300">+</button>
                                <button onclick="updateOrderQuantity(${index}, -1)" class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-xs hover:bg-yellow-300">-</button>
                                <button onclick="removeItemFromOrder(${index})" class="bg-red-200 text-red-800 px-2 py-1 rounded-full text-xs hover:bg-red-300">X</button>
                            </div>
                        `;
                        orderList.appendChild(li);
                    });
                }


                const { subtotal, totalQuantity, discountAmount, taxAmount, finalTotal } = calculateTotals();

                totalQtySpan.textContent = totalQuantity;
                subtotalSpan.textContent = subtotal.toFixed(2);
                document.getElementById("discountAmountDisplay").textContent = discountAmount.toFixed(2);
                document.getElementById("taxAmountDisplay").textContent = taxAmount.toFixed(2);
                finalTotalSpan.textContent = finalTotal.toFixed(2);
            }

            // --- Discount Logic ---
            cashDiscountBtn.addEventListener("click", () => {
                discountType = 'cash';
                discountInput.placeholder = "Enter cash amount (max 8% of subtotal)";
                discountInputGroup.classList.remove('hidden');
                discountInput.value = '';
                discountValue = 0; // Reset value when switching type
                updatePaymentSection();
            });

            percentageDiscountBtn.addEventListener("click", () => {
                discountType = 'percentage';
                discountInput.placeholder = "Enter percentage (max 5%)";
                discountInputGroup.classList.remove('hidden');
                discountInput.value = '';
                discountValue = 0; // Reset value when switching type
                updatePaymentSection();
            });

            discountInput.addEventListener("input", (e) => {
                let value = parseFloat(e.target.value);
                if (isNaN(value) || value < 0) {
                    value = 0;
                }

                const { subtotal } = calculateTotals();
                if (discountType === 'percentage') {
                    if (value > 5) {
                        value = 5;
                        e.target.value = 5;
                        alert("Percentage discount cannot exceed 5%.");
                    }
                } else if (discountType === 'cash') {
                    const maxCashDiscount = subtotal * 0.08;
                    if (value > maxCashDiscount) {
                        value = maxCashDiscount;
                        e.target.value = maxCashDiscount.toFixed(2);
                        alert(`Cash discount cannot exceed 8% of subtotal (TK${maxCashDiscount.toFixed(2)}).`);
                    }
                }
                discountValue = value;
                updatePaymentSection();
            });

            // --- Tax Logic ---
            taxInput.addEventListener("input", (e) => {
                let value = parseFloat(e.target.value);
                if (isNaN(value) || value < 0) {
                    value = 0;
                }
                taxPercentage = value;
                updatePaymentSection();
            });

            // Function to generate a unique 10-digit alphanumeric invoice number
            function generateUniqueInvoiceNumber() {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                const length = 10;
                for (let i = 0; i < length; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return result;
            }

            /**
             * Generates a PDF receipt for a given order.
             * @param {object} orderData - The order data to include in the receipt.
             * @returns {jsPDF} The jsPDF document object.
             */
            function generatePdfReceipt(orderData) {
                const { jsPDF } = window.jspdf;
                const receiptWidth = 58; // mm
                let y = 5; // Initial Y position, small top margin
                const marginX = 2; // Small left/right margin
                const centerX = receiptWidth / 2;

                // --- Calculate content height first ---
                let calculatedHeight = 0;
                // Logo placeholder height + space
                calculatedHeight += 15 + 4;
                // Header section height
                calculatedHeight += 5 + 4 + 4 + 4 + 5;
                // Invoice Details section height (now includes Invoice No and Order No)
                calculatedHeight += 5 + 5 + 5 + 5 + 5 + 5 + 6; // Added one more line for Order Number
                // Items Table Header height
                calculatedHeight += 4 + 4 + 4;
                // Items Table Rows height (dynamic)
                calculatedHeight += orderData.items.length * 5; // 5mm per item row
                calculatedHeight += 4 + 4; // Space after items table + line
                // Summary Section height
                calculatedHeight += 5 + 5 + 5 + 5 + 6;
                // Footer Section height
                calculatedHeight += 4 + 4; // Thank you + Website
                calculatedHeight += 2; // Minimal padding at the very end

                const doc = new jsPDF({
                    unit: 'mm',
                    format: [receiptWidth, calculatedHeight] // Set the precise height here
                });

                // --- Draw content using the actual 'y' variable ---
                // --- Logo Placeholder ---
                const logoRectHeight = 15;
                doc.rect(marginX, y, receiptWidth - (2 * marginX), logoRectHeight); // Rectangle for logo
                doc.setFontSize(8);
                doc.setFont("helvetica", "normal");
                doc.text("Your Logo Here", centerX, y + (logoRectHeight / 2) + 1, { align: "center" });
                y += logoRectHeight + 4; // Space after logo placeholder

                // --- Header Section ---
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text("SnacksLab", centerX, y, { align: "center" });
                y += 5; // Increased line spacing
                doc.setFontSize(7);
                doc.setFont("helvetica", "normal");
                doc.text("123 Food Street, Culinary City, FB 7890", centerX, y, { align: "center" });
                y += 4; // Increased line spacing
                doc.text("Phone: +8801234567890", centerX, y, { align: "center" });
                y += 4; // Increased line spacing
                doc.text("Email: info@snackslab.com", centerX, y, { align: "center" });
                y += 5; // Adjusted space after header block

                // --- Invoice Details Section ---
                doc.setFontSize(7);
                doc.setFont("helvetica", "bold");
                doc.text(`Invoice No: ${orderData.invoiceNumber}`, marginX, y); // New Invoice Number
                y += 5; // Increased line spacing
                doc.text(`Order Number: ${orderData.orderNumber}`, marginX, y); // Existing Order Number
                doc.text(`Date: ${new Date(orderData.timestamp).toLocaleDateString()}`, receiptWidth - marginX, y, { align: "right" });
                y += 5; // Increased line spacing
                doc.text(`Time: ${new Date(orderData.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`, receiptWidth - marginX, y, { align: "right" });
                y += 5; // Increased line spacing
                doc.text(`Customer Phone: ${orderData.customerPhoneNumber || 'N/A'}`, marginX, y);
                y += 5; // Increased line spacing
                doc.text(`Payment Status: Paid`, marginX, y); // Replaced Order Type
                y += 5; // Increased line spacing
                doc.text(`Placed By: Owner`, marginX, y); // Default value
                y += 6; // Adjusted space after details block

                // --- Items Table Header ---
                doc.setFontSize(7);
                doc.setFont("helvetica", "bold");
                const tableHeaders = ["Item", "Qty", "Rate", "Amount"];
                const colWidths = [25, 8, 10, 10]; // Adjusted widths for 58mm receipt
                let currentTableX = marginX;
                tableHeaders.forEach((header, i) => {
                    doc.text(header, currentTableX, y);
                    currentTableX += colWidths[i];
                });
                y += 4; // Increased line spacing
                doc.line(marginX, y, receiptWidth - marginX, y);
                y += 4; // Increased line spacing

                // --- Items Table Rows ---
                doc.setFont("helvetica", "normal");
                doc.setFontSize(7);
                orderData.items.forEach((item) => {
                    currentTableX = marginX;
                    doc.text(item.name, currentTableX, y);
                    currentTableX += colWidths[0];
                    doc.text(item.quantity.toString(), currentTableX, y);
                    currentTableX += colWidths[1];
                    doc.text(item.sellingPrice.toFixed(2), currentTableX, y);
                    currentTableX += colWidths[2];
                    doc.text((item.sellingPrice * item.quantity).toFixed(2), currentTableX, y);
                    y += 5; // Increased line spacing for each item
                });
                y += 4; // Adjusted space after items table
                doc.line(marginX, y, receiptWidth - marginX, y);
                y += 4; // Adjusted space after line

                // --- Summary Section ---
                doc.setFontSize(8);
                doc.setFont("helvetica", "normal");
                doc.text(`Subtotal: TK${orderData.subtotal.toFixed(2)}`, receiptWidth - marginX, y, { align: "right" });
                y += 5; // Increased line spacing
                doc.text(`Discount (${orderData.discountType === 'percentage' ? orderData.discountValue + '%' : 'Cash'}): TK${orderData.discountAmount.toFixed(2)}`, receiptWidth - marginX, y, { align: "right" });
                y += 5; // Increased line spacing
                doc.text(`Tax (${orderData.taxPercentage}%): TK${orderData.taxAmount.toFixed(2)}`, receiptWidth - marginX, y, { align: "right" });
                y += 5; // Increased line spacing
                doc.setFontSize(10);
                doc.setFont("helvetica", "bold");
                doc.text(`Grand Total: TK${orderData.finalTotal.toFixed(2)}`, receiptWidth - marginX, y, { align: "right" });
                y += 6; // Adjusted space after summary

                // --- Footer Section ---
                doc.setFontSize(8);
                doc.setFont("helvetica", "normal");
                doc.text("Thank you for your visit!", centerX, y, { align: "center" });
                y += 4; // Adjusted line spacing
                doc.text("www.snackslab.com", centerX, y, { align: "center" });

                return doc; // Return the doc object instead of printing directly
            }

            /**
             * Prints a jsPDF document directly without opening a new tab.
             * @param {jsPDF} doc - The jsPDF document object to print.
             */
            function printPdfDirectly(doc) {
                console.log("Attempting to print PDF directly.");
                const blob = doc.output('blob');
                const url = URL.createObjectURL(blob);

                const iframe = document.createElement('iframe');
                iframe.style.display = 'none'; // Keep it hidden
                iframe.src = url;

                iframe.onload = () => {
                    console.log("Iframe loaded. Attempting to print...");
                    try {
                        // Add a small delay to ensure content is rendered before printing
                        setTimeout(() => {
                            iframe.contentWindow.print();
                            console.log("Print command issued.");
                        }, 500); // 500ms delay for print command
                    } catch (e) {
                        console.error("Error triggering print from iframe:", e);
                        alert("Could not open print dialog. Please check your browser settings or try printing manually.");
                    } finally {
                        // Clean up after a longer delay to ensure print dialog interaction
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            if (iframe.parentNode) {
                                iframe.parentNode.removeChild(iframe);
                                console.log("Iframe removed from DOM.");
                            }
                        }, 120000); // Increased cleanup delay to 2 minutes (120000ms)
                    }
                };
                iframe.onerror = (e) => {
                    console.error("Iframe failed to load:", e);
                    alert("Failed to load PDF for printing. Please try again.");
                };
                document.body.appendChild(iframe);
            }


            // --- Print Receipt & Save Order (POS Section) ---
            printReceiptBtn.addEventListener("click", async () => {
                if (currentOrder.length === 0) {
                    alert("Please add items to the order first.");
                    return;
                }

                const { subtotal, totalQuantity, discountAmount, taxAmount, finalTotal } = calculateTotals();

                const todayDate = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                const dailyCounterRef = dbRef(db, `dailyCounters/${todayDate}/lastOrderNumber`);

                try {
                    const snapshot = await get(dailyCounterRef);
                    let nextOrderNumber = 1;
                    if (snapshot.exists()) {
                        nextOrderNumber = snapshot.val() + 1;
                    }

                    // Format order number to 3 digits (e.g., 001, 010, 100)
                    const formattedOrderNumber = String(nextOrderNumber).padStart(3, '0');
                    const newInvoiceNumber = generateUniqueInvoiceNumber(); // Generate unique invoice number

                    // Save order to Firebase with 'Processing' status
                    const orderPath = `orders/${todayDate}/${formattedOrderNumber}`;
                    const orderToSave = {
                        orderNumber: formattedOrderNumber,
                        invoiceNumber: newInvoiceNumber, // Save the new invoice number
                        timestamp: new Date().toISOString(),
                        items: currentOrder.map(item => ({
                            name: item.name,
                            quantity: item.quantity,
                            sellingPrice: item.sellingPrice
                        })),
                        subtotal: subtotal,
                        discountType: discountType,
                        discountValue: discountValue,
                        discountAmount: discountAmount,
                        taxPercentage: taxPercentage,
                        taxAmount: taxAmount,
                        finalTotal: finalTotal,
                        customerPhoneNumber: customerPhoneInput.value.trim(),
                        couponCode: couponCodeInput.value.trim(),
                        paymentMethod: 'Cash', // Default payment method
                        orderStatus: 'Processing' // New: Initial order status
                    };
                    await set(dbRef(db, orderPath), orderToSave);

                    // Update the daily counter
                    await set(dailyCounterRef, nextOrderNumber);

                    console.log(`Order ${formattedOrderNumber} saved to Firebase successfully!`);

                    // Generate PDF and then print it directly
                    const pdfDoc = generatePdfReceipt(orderToSave);
                    printPdfDirectly(pdfDoc);

                    // Clear the order after printing
                    clearOrder();
                    loadProcessingOrders(); // Refresh processing orders list
                    alert(`Order ${formattedOrderNumber} finalized and receipt printed!`);

                } catch (error) {
                    console.error("Error processing order:", error);
                    alert("Failed to finalize order. Please try again.");
                }
            });

            // --- Clear Order Button ---
            clearOrderBtn.addEventListener("click", clearOrder);

            function clearOrder() {
                currentOrder = [];
                discountType = null;
                discountValue = 0;
                taxPercentage = 0;
                discountInput.value = '';
                discountInputGroup.classList.add('hidden');
                taxInput.value = '0';
                customerPhoneInput.value = '';
                couponCodeInput.value = '';
                updatePaymentSection();
            }

            // --- Order Status Functions ---
            function loadProcessingOrders() {
                // Listen for changes in orders for today
                const todayDate = new Date().toISOString().split('T')[0];
                const dailyOrdersRef = dbRef(db, `orders/${todayDate}`);

                onValue(dailyOrdersRef, (snapshot) => {
                    orderStatusList.innerHTML = ''; // Clear previous list
                    let hasProcessingOrders = false;
                    if (snapshot.exists()) {
                        snapshot.forEach(child => {
                            const order = child.val();
                            const orderKey = child.key; // This is the formattedOrderNumber
                            if (order.orderStatus === 'Processing') {
                                hasProcessingOrders = true;
                                const orderDateTime = new Date(order.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                                const orderCard = document.createElement('div');
                                orderCard.className = "bg-white p-4 rounded-lg shadow-md mb-3";
                                orderCard.innerHTML = `
                                    <p class="font-bold text-lg text-gray-800">Order #${order.orderNumber} <span class="text-sm text-gray-500">(${orderDateTime})</span></p>
                                    <p class="text-sm text-gray-600">Total: TK${order.finalTotal.toFixed(2)}</p>
                                    <p class="text-sm text-gray-600">Phone: ${order.customerPhoneNumber || 'N/A'}</p>
                                    <p class="text-sm font-semibold text-orange-600 mb-2">Status: Processing</p>
                                    <button onclick="markOrderAsDelivered('${todayDate}', '${orderKey}')"
                                        class="bg-green-600 hover:bg-green-700 text-white py-1.5 px-3 rounded text-sm transition-colors duration-200 w-full">
                                        Mark as Delivered
                                    </button>
                                `;
                                orderStatusList.appendChild(orderCard);
                            }
                        });
                    }
                    if (!hasProcessingOrders) {
                        orderStatusList.innerHTML = '<p class="text-center text-gray-500 py-4">No processing orders for today.</p>';
                    }
                });
            }

            window.markOrderAsDelivered = async function (orderDate, orderNumber) {
                const orderRef = dbRef(db, `orders/${orderDate}/${orderNumber}`);
                try {
                    await update(orderRef, { orderStatus: 'Delivered' });
                    console.log(`Order ${orderNumber} marked as Delivered in Firebase.`);
                    // loadProcessingOrders() will automatically update the UI due to onValue listener
                } catch (error) {
                    console.error("Error marking order as delivered:", error);
                    alert("Failed to update order status. Please try again.");
                }
            }

            // Function to reprint a specific order's receipt
            window.reprintOrderReceipt = function(order) {
                const pdfDoc = generatePdfReceipt(order);
                printPdfDirectly(pdfDoc);
            };


            // --- Sales Report Functions ---
            todaySalesBtn.addEventListener("click", () => {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                const todayIso = `${year}-${month}-${day}`;

                fromDateInput.value = todayIso;
                toDateInput.value = todayIso;
                loadSalesReport(todayIso, todayIso);
            });

            generateDateRangeReportBtn.addEventListener("click", () => {
                const fromDate = fromDateInput.value;
                const toDate = toDateInput.value;
                if (!fromDate || !toDate) {
                    alert("Please select both 'From Date' and 'To Date' for the report.");
                    return;
                }
                if (new Date(fromDate) > new Date(toDate)) {
                    alert("'From Date' cannot be after 'To Date'.");
                    return;
                }
                loadSalesReport(fromDate, toDate);
            });

            searchReportBtn.addEventListener("click", () => {
                const fromDate = fromDateInput.value;
                const toDate = toDateInput.value;
                const searchTerm = searchReportInput.value.trim();
                const searchType = searchReportType.value;
                if (!fromDate || !toDate) {
                    alert("Please select a date range first.");
                    return;
                }
                loadSalesReport(fromDate, toDate, searchTerm, searchType);
            });

            // New function to toggle order details
            window.toggleOrderDetails = function(orderId) {
                const detailsSection = document.getElementById(`details-section-${orderId}`);
                const detailsButton = document.getElementById(`detailsBtn-${orderId}`);

                if (detailsSection.classList.contains('hidden')) {
                    detailsSection.classList.remove('hidden');
                    detailsButton.textContent = 'Hide Details';
                    detailsButton.classList.remove('bg-blue-500', 'hover:bg-blue-700');
                    detailsButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
                } else {
                    detailsSection.classList.add('hidden');
                    detailsButton.textContent = 'View Details';
                    detailsButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                    detailsButton.classList.add('bg-blue-500', 'hover:bg-blue-700');
                }
            };

            async function loadSalesReport(startDate, endDate, searchTerm = '', searchType = '') {
                ordersReportList.innerHTML = '<p class="text-center text-gray-500 py-4 col-span-full">Loading sales data...</td></tr>';
                totalSalesReport.textContent = 'Calculating...';
                let grandTotalSales = 0;
                currentReportData = []; // Clear previous report data

                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setDate(end.getDate() + 1); // Include the end date

                for (let d = new Date(start); d < end; d.setDate(d.getDate() + 1)) {
                    const dateString = d.toISOString().split('T')[0];
                    const dailyOrdersRef = dbRef(db, `orders/${dateString}`);
                    try {
                        const snapshot = await get(dailyOrdersRef); // Use get for one-time read
                        if (snapshot.exists()) {
                            snapshot.forEach(child => {
                                currentReportData.push(child.val());
                            });
                        }
                    } catch (error) {
                        console.error(`Error fetching orders for ${dateString}:`, error);
                    }
                }

                // Filter data based on search term (exact match)
                let filteredReportData = currentReportData;
                if (searchTerm) {
                    filteredReportData = currentReportData.filter(order => {
                        if (searchType === 'totalAmount') {
                            // Convert both to fixed-point strings for exact comparison
                            return parseFloat(order.finalTotal).toFixed(2) === parseFloat(searchTerm).toFixed(2);
                        } else if (searchType === 'phoneNumber') {
                            // Exact string match for phone number
                            return (order.customerPhoneNumber && order.customerPhoneNumber === searchTerm);
                        } else if (searchType === 'invoiceNumber') { // New search type
                            return (order.invoiceNumber && order.invoiceNumber.toLowerCase() === searchTerm.toLowerCase());
                        }
                        return true; // No search type or empty search term, show all
                    });
                }


                ordersReportList.innerHTML = ''; // Clear loading message before populating

                if (filteredReportData.length === 0) {
                    ordersReportList.innerHTML = '<p class="text-center text-gray-500 py-4 col-span-full">No sales recorded for the selected period or matching your search criteria.</p>';
                    totalSalesReport.textContent = 'TK0.00';
                    return;
                }

                // Sort orders by timestamp for consistent display
                filteredReportData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                filteredReportData.forEach(order => {
                    grandTotalSales += order.finalTotal;
                    const orderDateTime = new Date(order.timestamp).toLocaleString();
                    const orderId = `${new Date(order.timestamp).getTime()}-${order.orderNumber}`; // Unique ID for details section

                    // Determine status color
                    let statusColorClass = '';
                    if (order.orderStatus === 'Processing') {
                        statusColorClass = 'text-red-700'; // Deep red
                    } else if (order.orderStatus === 'Delivered') {
                        statusColorClass = 'text-green-500'; // Light green
                    }


                    const orderCard = document.createElement('div');
                    orderCard.className = "bg-white p-6 rounded-lg shadow-md flex flex-col justify-between"; // Card styling

                    orderCard.innerHTML = `
                        <div class="mb-4">
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Order No: ${order.orderNumber}</h3>
                            <p class="text-gray-600 text-sm">Invoice No: ${order.invoiceNumber || 'N/A'}</p>
                            <p class="text-600 text-sm">Date: ${orderDateTime}</p>
                            <div class="grid grid-cols-2 gap-2 mt-2 text-sm">
                                <p><span class="font-semibold">Status:</span> <span class="${statusColorClass}">${order.orderStatus || 'N/A'}</span></p>
                                <p><span class="font-semibold">Payment:</span> ${order.paymentMethod}</p>
                                <p><span class="font-semibold">Placed By:</span> Owner</p>
                                <p><span class="font-semibold">Discount:</span> TK${order.discountAmount.toFixed(2)}</p>
                            </div>
                            <p class="text-lg font-bold text-green-700 mt-3">Total: TK${order.finalTotal.toFixed(2)}</p>
                        </div>

                        <!-- Collapsible Details Section -->
                        <div id="details-section-${orderId}" class="hidden mt-4 pt-4 border-t border-gray-200">
                            <p class="font-semibold text-sm mb-1">Customer Phone: ${order.customerPhoneNumber || 'N/A'}</p>
                            <p class="font-semibold text-sm mb-1">Coupon Code: ${order.couponCode || 'N/A'}</p>
                            <p class="font-semibold text-sm mb-1">Subtotal: TK${order.subtotal.toFixed(2)}</p>
                            <p class="font-semibold text-sm mb-1">Tax (${order.taxPercentage}%): TK${order.taxAmount.toFixed(2)}</p>
                            <h4 class="font-semibold text-sm mt-2 mb-1">Items:</h4>
                            <ul class="list-disc list-inside ml-4 text-sm">
                                ${order.items.map(item => `<li>${item.name} x ${item.quantity} (TK${item.sellingPrice.toFixed(2)} each)</li>`).join('')}
                            </ul>
                        </div>
                        <button onclick="reprintOrderReceipt(JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(order))}')))"
                            class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 shadow-md w-full">
                            Print Receipt
                        </button>
                        <button id="detailsBtn-${orderId}" onclick="toggleOrderDetails('${orderId}')"
                            class="mt-2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 shadow-md w-full">
                            View Details
                        </button>
                    `;
                    ordersReportList.appendChild(orderCard);
                });
                totalSalesReport.textContent = `TK${grandTotalSales.toFixed(2)}`;
            }

            exportSalesReportPdfBtn.addEventListener("click", () => {
                console.log("Export to PDF button clicked."); // Debugging log
                if (currentReportData.length === 0) {
                    alert("No sales data to export for the current report. Please generate a report first.");
                    return;
                }

                const { jsPDF } = window.jspdf;
                // Set orientation to landscape
                const doc = new jsPDF({ orientation: 'landscape' });
                let y = 15; // Starting Y position
                const margin = 15;
                const lineHeight = 7;
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height; // Get page height for landscape

                // --- Logo Placeholder Rectangle (Top and Middle) ---
                const logoRectWidth = 50; // mm
                const logoRectHeight = 20; // mm
                const logoRectX = (pageWidth / 2) - (logoRectWidth / 2); // Center horizontally
                const logoRectY = margin; // Top margin
                doc.rect(logoRectX, logoRectY, logoRectWidth, logoRectHeight, 'S'); // 'S' for stroke
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text("Your Logo Here", logoRectX + (logoRectWidth / 2), logoRectY + (logoRectHeight / 2) + 1, { align: "center" });
                y = logoRectY + logoRectHeight + lineHeight * 2; // Move Y below the logo rectangle

                // --- Header ---
                doc.setFontSize(24);
                doc.setFont("helvetica", "bold");
                doc.text("SnacksLab Sales Report", pageWidth / 2, y, { align: "center" }); // Updated title
                y += lineHeight * 1.2;
                doc.setFontSize(14);
                doc.text("Detailed Sales Overview", pageWidth / 2, y, { align: "center" }); // Subtitle
                y += lineHeight * 0.8;
                doc.setFontSize(10);
                doc.setFont("helvetica", "normal");
                doc.text(`Report Period: ${fromDateInput.value} to ${toDateInput.value}`, margin, y);
                y += lineHeight;
                doc.text(`Generated On: ${new Date().toLocaleString()}`, margin, y);
                y += lineHeight * 2;

                // --- Total Sales Summary ---
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text(`Grand Total Sales: ${totalSalesReport.textContent.replace('', 'TK')}`, margin, y);
                y += lineHeight * 2;

                // --- Detailed Orders in Table Format ---
                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("Detailed Orders:", margin, y);
                y += lineHeight * 1.5;

                // Define table headers
                const headers = [
                    "Order no",
                    "Invoice no",
                    "Date & time",
                    "Order status",
                    "Payment type",
                    "Placed by",
                    "Subtotal",
                    "Discount",
                    "Tax",
                    "Coupon code",
                    "Total"
                ];

                // Prepare table data
                const tableData = currentReportData.map(order => [
                    order.orderNumber,
                    order.invoiceNumber || 'N/A',
                    new Date(order.timestamp).toLocaleString(),
                    order.orderStatus || 'N/A',
                    order.paymentMethod,
                    'Owner', // Assuming 'Owner' as per the image
                    order.subtotal.toFixed(2),
                    order.discountAmount.toFixed(2),
                    order.taxAmount.toFixed(2),
                    order.couponCode || 'N/A',
                    order.finalTotal.toFixed(2)
                ]);

                // Generate table using autoTable
                doc.autoTable({
                    startY: y, // Start table at current Y position
                    head: [headers],
                    body: tableData,
                    theme: 'grid', // Add grid lines for a clear table
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                        halign: 'center' // Center align all cells
                    },
                    headStyles: {
                        fillColor: [200, 200, 200], // Light gray header background
                        textColor: [0, 0, 0],
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        // Specific column widths or alignment if needed
                        0: { halign: 'center' }, // Order no
                        1: { halign: 'center' }, // Invoice no
                        2: { halign: 'center' }, // Date & time
                        3: { halign: 'center' }, // Order status
                        4: { halign: 'center' }, // Payment type
                        5: { halign: 'center' }, // Placed by
                        6: { halign: 'right' }, // Subtotal
                        7: { halign: 'right' }, // Discount
                        8: { halign: 'right' }, // Tax
                        9: { halign: 'center' }, // Coupon code
                        10: { halign: 'right' } // Total
                    },
                    didDrawPage: function (data) {
                        // Update Y position after table is drawn
                        y = data.cursor.y;
                    }
                });

                y += lineHeight; // Space after table

                doc.save(`sales_report_${fromDateInput.value}_to_${toDateInput.value}.pdf`);
                alert("Sales report exported to PDF!");
            });


            // --- Initial Load: Show Homepage ---
            showView("homePage");
        });
    </script>
    <style>
        /* General body padding for fixed footer */
        body {
            padding-top: 64px;
            /* Space for the fixed header */
            padding-bottom: 40px;
            /* Space for the fixed date/time display */
            position: relative;
            /* Needed for footer positioning */
        }

        /* Fixed Header Bar */
        .header-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #f8f8f8; /* Off-white background */
            color: #333; /* Dark text for contrast */
            padding: 0.75rem 1rem; /* py-3 px-4 */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Lighter shadow */
            z-index: 1000;
            border-bottom: 1px solid #e0e0e0; /* Subtle border */
        }

        .header-bar h1 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem; /* text-xl */
            font-weight: bold;
            cursor: pointer;
            color: #333; /* Ensure title is dark */
        }

        .header-nav-buttons {
            display: flex;
            gap: 1rem; /* Increased gap for spacing */
            align-items: center;
            flex-grow: 1; /* Allow buttons to take available space */
            justify-content: center; /* Center the buttons */
        }

        .header-nav-btn {
            background-color: transparent; /* No background for nav links */
            color: #333; /* Dark text for contrast */
            padding: 0.5rem 1rem;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600;
            transition: color 0.2s, background-color 0.2s;
        }

        .header-nav-btn:hover {
            background-color: black; /* Black background on hover */
            color: white; /* White text on hover */
        }

        /* Active button style */
        .header-nav-btn.bg-gray-200 { /* Changed from bg-blue-700 */
            background-color: #e0e0e0; /* Slightly darker off-white for active */
            color: #333; /* Keep text dark for active state */
        }

        /* Login Button specific styling */
        .login-btn {
            background-color: white;
            color: #1a202c; /* Dark text for contrast */
            padding: 0.5rem 1.25rem; /* py-2 px-5 */
            border-radius: 9999px; /* rounded-full */
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .login-btn:hover {
            background-color: #edf2f7; /* Lighter white on hover */
            transform: translateY(-1px); /* Subtle lift effect */
        }

        /* Fixed Date/Time Display at the bottom right */
        .datetime-footer {
            position: fixed;
            bottom: 0;
            right: 0;
            background-color: #f3f4f6;
            /* bg-gray-100 */
            padding: 0.5rem 1rem;
            /* py-2 px-4 */
            font-size: 0.875rem;
            /* text-sm */
            color: #4b5563;
            /* text-gray-600 */
            border-top-left-radius: 0.5rem;
            /* rounded-tl-lg */
            z-index: 1000;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        /* Home Page Button Responsiveness */
        #homePage .grid {
            grid-template-columns: 1fr;
            /* Single column on small screens */
            gap: 1.5rem;
            /* Tailwind gap-6 */
        }

        @media (min-width: 768px) {
            /* md breakpoint */
            #homePage .grid {
                grid-template-columns: repeat(3, 1fr);
                /* 3 columns on medium screens and up */
            }
        }

        /* POS View Container (main layout for sell items) */
        .pos-container {
            display: grid;
            grid-template-columns: 1fr;
            /* Stack vertically on small screens */
            gap: 1.5rem;
            /* Tailwind gap-6 */
            max-width: 100%;
            /* Increased max-width for more space */
            margin-left: auto;
            margin-right: auto;
            padding: 1.5rem;
            /* p-6 */
        }

        /* Responsive layout for POS sections */
        @media (min-width: 768px) {
            /* md breakpoint */
            .pos-container {
                grid-template-columns: 2fr 1fr;
                /* Product selection on left, current order + status stacked on right */
            }

            .pos-order-sidebar {
                grid-column: 2 / 3;
                /* Place current order in the second column */
                grid-row: 1 / 2;
                /* Place it in the first row */
            }

            .pos-order-status-sidebar {
                grid-column: 2 / 3;
                /* Place order status in the second column */
                grid-row: 2 / 3;
                /* Place it in the second row, below current order */
            }
        }

        @media (min-width: 1024px) {
            /* lg breakpoint */
            .pos-container {
                grid-template-columns: 2fr 1fr 1fr;
                /* Product Selection, Current Order, Order Status */
                align-items: flex-start;
                /* Align items to the top */
            }

            .pos-product-selection {
                overflow-y: auto;
                /* Enable scrolling for product list */
                max-height: calc(100vh - 3rem - 64px);
                /* Adjust height for sticky behavior and header */
                padding-bottom: 40px;
                /* Account for fixed footer */
                grid-column: 1 / 2;
                /* Explicitly place in first column */
                grid-row: 1 / 2;
                /* Explicitly place in first row */
            }

            .pos-order-sidebar {
                position: sticky;
                top: calc(1.5rem + 64px);
                /* Stick to top with some margin + header height */
                max-height: calc(100vh - 3rem - 40px - 64px);
                /* Full viewport height minus margins/footer/header */
                overflow-y: auto;
                /* Enable scrolling for order list if it gets too long */
                grid-column: 2 / 3;
                /* Explicitly place in second column */
                grid-row: 1 / 2;
                /* Explicitly place in first row */
                width: 100%;
                /* Ensure it takes full column width */
            }

            .pos-order-status-sidebar {
                position: sticky;
                top: calc(1.5rem + 64px);
                /* Stick to top with some margin + header height */
                max-height: calc(100vh - 3rem - 40px - 64px);
                /* Full viewport height minus margins/footer/header */
                overflow-y: auto;
                /* Enable scrolling for order list if it gets too long */
                grid-column: 3 / 4;
                /* Explicitly place in third column */
                grid-row: 1 / 2;
                /* Explicitly place in first row */
                width: 100%;
                /* Ensure it takes full column width */
            }

            /* Adjust the height for the order list to take more space within the sidebar */
            .pos-order-sidebar .flex-grow {
                flex-grow: 2;
                /* Allows it to take more space than other flexible items */
                min-height: 250px;
                /* Ensure a minimum height for visibility */
            }
        }

        /* Product Card Responsiveness in POS and Manage Items */
        #posItemsList,
        #manageItemsList {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            /* Responsive grid for small cards */
            gap: 1rem;
            /* Smaller gap for more items per row */
        }

        @media (min-width: 640px) {
            /* sm breakpoint */
            #posItemsList,
            #manageItemsList {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        @media (min-width: 768px) {
            /* md breakpoint */
            #posItemsList,
            #manageItemsList {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        @media (min-width: 1024px) {
            /* lg breakpoint - specifically for posItemsList only, as sidebar is different */
            #posItemsList {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                /* Slightly smaller cards if needed on large screens */
            }

            #manageItemsList {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }

        /* Sales Report Card System Styling */
        #ordersReportList {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            /* Responsive grid for cards */
            gap: 1.5rem;
            /* Tailwind gap-6 */
        }

        @media (min-width: 640px) {
            /* sm breakpoint */
            #ordersReportList {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        @media (min-width: 768px) {
            /* md breakpoint */
            #ordersReportList {
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            }
        }

        @media (min-width: 1024px) {
            /* lg breakpoint */
            #ordersReportList {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                /* Adjust for 3 columns on larger screens */
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen p-4 font-sans">
    <!-- Fixed Header Bar -->
    <header class="header-bar">
        <h1 id="mainHeaderTitle">
            <!-- Logo SVG will be inserted here by JavaScript -->
            SnacksLab
        </h1>
        <nav class="header-nav-buttons">
            <button id="navManageItemsBtn" class="header-nav-btn">
                Products
            </button>
            <button id="navSellItemsBtn" class="header-nav-btn">
                POS
            </button>
            <button id="navSalesReportBtn" class="header-nav-btn">
                Reports
            </button>
        </nav>
        <button id="loginBtn" class="login-btn">
            Login
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM12.755 14.5A7.462 7.462 0 0110 16.5a7.462 7.462 0 01-2.755-2A5.462 5.462 0 0110 12c.965 0 1.897.18 2.755.5z" clip-rule="evenodd" />
            </svg>
        </button>
    </header>

    <!-- Homepage View -->
    <div id="homePage" class="max-w-4xl mx-auto py-16 px-4 bg-white rounded-lg shadow-xl text-center">
        <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-8">Welcome to SnacksLab POS </h1>
        <p class="text-lg sm:text-xl text-gray-700 mb-12">Select an option to get started:</p>
        <div class="grid">
            <button id="manageItemsBtn"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-5 px-6 rounded-lg shadow-lg text-xl transition duration-300 ease-in-out transform hover:scale-105">
                 Add/Edit Products
            </button>
            <button id="sellItemsBtn"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-5 px-6 rounded-lg shadow-lg text-xl transition duration-300 ease-in-out transform hover:scale-105">
                 Sell Items (POS)
            </button>
            <button id="generateReportBtn"
                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-5 px-6 rounded-lg shadow-lg text-xl transition duration-300 ease-in-out transform hover:scale-105">
                 Generate Sales Report
            </button>
        </div>
    </div>

    <!-- manageItemsView: Item Management Section -->
    <div id="manageItemsView" class="hidden max-w-6xl mx-auto py-6 px-4">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <h1 id="manageItemsHeader" class="flex items-center justify-center gap-3 text-2xl sm:text-3xl font-bold mb-6 text-center text-gray-800">
                Manage Products
            </h1>

            <!-- Add/Edit Item Form -->
            <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700">Add/Edit Product</h2>
            <form id="addItemForm"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 p-4 rounded-lg shadow-inner mb-8">
                <input type="text" id="itemName" placeholder="Product Name" required
                    class="border p-2.5 rounded focus:ring-blue-500 focus:border-blue-500 text-sm" />
                <input type="text" id="itemImageUrl" placeholder="Image URL" required
                    class="border p-2.5 rounded focus:ring-blue-500 focus:border-blue-500 text-sm" />
                <input type="number" step="0.01" id="itemCost" placeholder="Cost Price (TK)" required
                    class="border p-2.5 rounded focus:ring-blue-500 focus:border-blue-500 text-sm" />
                <input type="number" step="0.01" id="itemSell" placeholder="Selling Price (TK)" required
                    class="border p-2.5 rounded focus:ring-blue-500 focus:border-blue-500 text-sm" />
                <button type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded col-span-full transition-colors duration-200 text-base">Save
                    Item</button>
            </form>

            <!-- All Items Display -->
            <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700">All Available Products</h2>
            <div id="manageItemsList" class="grid">
                <!-- Items will be loaded here from Firebase for management -->
            </div>
        </div>
    </div>

    <!-- posView: POS (Sell Items) Section -->
    <div id="posView" class="hidden w-full p-4 pt-16">
        <div class="pos-container">
            <!-- Left Section: Product Selection -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-xl pos-product-selection">
                <h1 id="posHeader"
                    class="flex items-center justify-center gap-3 text-2xl sm:text-3xl font-bold mb-6 text-center text-gray-800">
                    Sell Items (POS)
                </h1>
                <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700">Select Products</h2>
                <div id="posItemsList" class="grid">
                    <!-- Products will be dynamically loaded here from Firebase for selection -->
                </div>
            </div>

            <!-- Middle Section: Current Order -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-xl flex flex-col pos-order-sidebar">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-center text-gray-800">Current Order</h2>

                <!-- Order List -->
                <div class="flex-grow overflow-y-auto mb-2 border border-gray-200 rounded p-2 sm:p-3"
                    style="min-height: 200px;">
                    <ul id="orderList" class="divide-y divide-gray-100">
                        <!-- Order items will be displayed here -->
                    </ul>
                </div>

                <!-- Summary -->
                <div class="bg-gray-50 p-2 rounded-lg text-gray-800 text-sm mb-2">
                    <p class="flex justify-between mb-0.5">Items: <span id="totalQty" class="font-semibold">0</span></p>
                    <p class="flex justify-between mb-0.5">Subtotal: TK<span id="subtotal" class="font-semibold">0.00</span></p>
                    <p class="flex justify-between mb-0.5">Discount: TK<span id="discountAmountDisplay"
                            class="font-semibold">0.00</span></p>
                    <p class="flex justify-between mb-0.5">Tax: TK<span id="taxAmountDisplay" class="font-semibold">0.00</span></p>
                    <p class="flex justify-between text-lg font-bold text-green-700 border-t pt-1 mt-1">Total: TK<span
                            id="finalTotal">0.00</span></p>
                </div>

                <!-- Discount Options -->
                <div class="mb-2">
                    <label class="block text-gray-700 text-xs font-bold mb-1">Discount:</label>
                    <div class="flex gap-1 mb-1">
                        <button id="cashDiscountBtn"
                            class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-1.5 px-2 rounded text-xs transition-colors duration-200">Cash</button>
                        <button id="percentageDiscountBtn"
                            class="flex-1 bg-purple-500 hover:bg-purple-600 text-white py-1.5 px-2 rounded text-xs transition-colors duration-200">Percentage</button>
                    </div>
                    <div id="discountInputGroup" class="hidden">
                        <input type="number" step="0.01" id="discountInput" placeholder="Discount Value"
                            class="border p-1.5 rounded w-full text-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                </div>

                <!-- Tax Option -->
                <div class="mb-2">
                    <label for="taxInput" class="block text-gray-700 text-xs font-bold mb-1">Tax Percentage (%):</label>
                    <input type="number" step="0.01" id="taxInput" value="0"
                        class="border p-1.5 rounded w-full text-sm focus:ring-blue-500 focus:border-blue-500" />
                </div>

                <!-- Customer Details & Coupon -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                    <div>
                        <label for="customerPhone" class="block text-gray-700 text-xs font-bold mb-1">Customer Phone:</label>
                        <input type="tel" id="customerPhone" placeholder="+8801XXXXXXXXX"
                            class="border p-1.5 rounded w-full text-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div>
                        <label for="couponCode" class="block text-gray-700 text-xs font-bold mb-1">Coupon Code:</label>
                        <input type="text" id="couponCode" placeholder="Enter code"
                            class="border p-1.5 rounded w-full text-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="printReceiptBtn"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded text-base font-semibold transition-colors duration-200">Print
                        Receipt</button>
                    <button id="clearOrderBtn"
                        class="flex-1 bg-gray-400 hover:bg-gray-500 text-white py-2 px-3 rounded text-base font-semibold transition-colors duration-200">Clear
                        Order</button>
                </div>
            </div>

            <!-- Right Section: Order Status -->
            <div class="bg-white p-4 sm:p-6 rounded-lg shadow-xl flex flex-col pos-order-status-sidebar">
                <h2 class="text-xl sm:text-2xl font-bold mb-4 text-center text-gray-800">Order Status</h2>
                <div id="orderStatusList" class="flex-grow overflow-y-auto">
                    <!-- Processing orders will be loaded here -->
                    <p class="text-center text-gray-500 py-4">No processing orders for today.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- salesReportView: Sales Report Section -->
    <div id="salesReportView" class="hidden max-w-6xl mx-auto py-6 px-4 pt-16">
        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-xl">
            <h1 id="salesReportHeader" class="flex items-center justify-center gap-3 text-2xl sm:text-3xl font-bold mb-6 text-center text-gray-800">
                Sales Report 
            </h1>

            <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                <h2 class="text-lg sm:text-xl font-semibold mb-3 text-gray-700">Filter Sales:</h2>
                <div class="flex flex-col md:flex-row gap-4 items-center mb-4">
                    <button id="todaySalesBtn"
                        class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded transition-colors duration-200 flex-shrink-0 text-sm">Today's
                        Sales</button>
                    <div class="flex items-center gap-2 w-full flex-wrap">
                        <label for="fromDate" class="text-gray-700 text-sm">From:</label>
                        <input type="date" id="fromDate"
                            class="border p-2 rounded w-full sm:w-auto flex-grow focus:ring-blue-500 focus:border-blue-500 text-sm" />
                        <label for="toDate" class="text-gray-700 text-sm">To:</label>
                        <input type="date" id="toDate"
                            class="border p-2 rounded w-full sm:w-auto flex-grow focus:ring-blue-500 focus:border-blue-500 text-sm" />
                        <button id="generateDateRangeReportBtn"
                            class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded transition-colors duration-200 flex-shrink-0 text-sm">Generate
                            Report</button>
                    </div>
                </div>

                <!-- Search Section -->
                <div class="flex flex-col md:flex-row gap-4 items-center mb-4">
                    <input type="text" id="searchReportInput" placeholder="Search by total amount, phone or invoice"
                        class="border p-2.5 rounded w-full md:w-auto flex-grow focus:ring-blue-500 focus:border-blue-500 text-sm" />
                    <select id="searchReportType"
                        class="border p-2.5 rounded w-full md:w-auto flex-shrink-0 focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="">Select Search Type</option>
                        <option value="totalAmount">Total Amount</option>
                        <option value="phoneNumber">Phone Number</option>
                        <option value="invoiceNumber">Invoice Number</option>
                    </select>
                    <button id="searchReportBtn"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded transition-colors duration-200 flex-shrink-0 text-sm">Search</button>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg text-blue-800 text-lg sm:text-xl font-bold mb-6 text-center">
                Total Sales for Period: <span id="totalSalesReport" class="text-green-700">TK0.00</span>
            </div>

            <h2 class="text-lg sm:text-xl font-semibold mb-4 text-gray-700">Detailed Orders:</h2>
            <!-- Changed back to div for card layout -->
            <div id="ordersReportList" class="grid">
                <!-- Sales order cards will be loaded here -->
                <p class="text-center text-gray-500 col-span-full">Select a date range or "Today's Sales" to view
                    reports.</p>
            </div>

            <div class="mt-6 text-center">
                <button id="exportSalesReportPdfBtn"
                    class="bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-lg font-semibold transition-colors duration-200">Export
                    Report to PDF</button>
            </div>
        </div>
    </div>

    <div id="dateTimeDisplay" class="datetime-footer"></div>
</body>

</html>

